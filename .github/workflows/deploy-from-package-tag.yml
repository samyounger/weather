name: Deploy From Package Tag

on:
  push:
    tags:
      - "pkg/*/v*"

permissions:
  contents: read
  deployments: write
  id-token: write

jobs:
  parse-tag:
    runs-on: ubuntu-latest
    outputs:
      package: ${{ steps.parse.outputs.package }}
      version: ${{ steps.parse.outputs.version }}
      environment: ${{ steps.parse.outputs.environment }}
      supports_cloudformation: ${{ steps.parse.outputs.supports_cloudformation }}
    steps:
      - name: Parse package tag
        id: parse
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          # Expected format: pkg/<package>/v<semver>
          package="${tag#pkg/}"
          package="${package%%/v*}"
          version="${tag##*/v}"

          supports_cloudformation=false
          environment=""
          case "$package" in
            store-observations|fetch-observations|refine-observations|backfill-observations)
              supports_cloudformation=true
              environment="prod-${package}"
              ;;
            github-tempest-cfn-deploy-role)
              supports_cloudformation=true
              environment="prod-github-tempest-cfn-deploy-role"
              ;;
            cloud-computing)
              supports_cloudformation=false
              environment="package-cloud-computing"
              ;;
          esac

          echo "package=$package" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "environment=$environment" >> "$GITHUB_OUTPUT"
          echo "supports_cloudformation=$supports_cloudformation" >> "$GITHUB_OUTPUT"

  create-deployment:
    needs: parse-tag
    if: needs.parse-tag.outputs.supports_cloudformation == 'true'
    runs-on: ubuntu-latest
    outputs:
      deployment_id: ${{ steps.create.outputs.deployment_id }}
    steps:
      - name: Create GitHub deployment
        id: create
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: '${{ needs.parse-tag.outputs.environment }}',
              transient_environment: false,
              production_environment: true,
              auto_merge: false,
              required_contexts: [],
              description: 'Deploying ${{ needs.parse-tag.outputs.package }} ${{ needs.parse-tag.outputs.version }}'
            });

            core.setOutput('deployment_id', String(deployment.data.id));

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'in_progress',
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'Deployment started'
            });

  deploy-store:
    needs:
      - parse-tag
      - create-deployment
    if: needs.parse-tag.outputs.package == 'store-observations'
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.sha }}
      package_workspace: "@weather/store-observations"
      package_directory: packages/store-observations
      artifact_bucket: tempest-artifacts-store-prod-926898703023
    secrets: inherit

  deploy-fetch:
    needs:
      - parse-tag
      - create-deployment
    if: needs.parse-tag.outputs.package == 'fetch-observations'
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.sha }}
      package_workspace: "@weather/fetch-observations"
      package_directory: packages/fetch-observations
      artifact_bucket: tempest-artifacts-fetch-prod-926898703023
    secrets: inherit

  deploy-refine:
    needs:
      - parse-tag
      - create-deployment
    if: needs.parse-tag.outputs.package == 'refine-observations'
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.sha }}
      package_workspace: "@weather/refine-observations"
      package_directory: packages/refine-observations
      artifact_bucket: tempest-artifacts-refine-prod-926898703023
    secrets: inherit

  deploy-backfill:
    needs:
      - parse-tag
      - create-deployment
    if: needs.parse-tag.outputs.package == 'backfill-observations'
    uses: ./.github/workflows/reusable-deploy-sam-backfill.yml
    with:
      checkout_ref: ${{ github.sha }}
      artifact_bucket: tempest-artifacts-backfill-prod-926898703023
    secrets: inherit

  deploy-role-policy:
    needs:
      - parse-tag
      - create-deployment
    if: needs.parse-tag.outputs.package == 'github-tempest-cfn-deploy-role'
    uses: ./.github/workflows/reusable-deploy-role-policy.yml
    with:
      checkout_ref: ${{ github.sha }}
    secrets: inherit

  deploy-cloud-computing:
    needs: parse-tag
    if: needs.parse-tag.outputs.package == 'cloud-computing'
    uses: ./.github/workflows/reusable-deploy-cloud-computing.yml
    with:
      checkout_ref: ${{ github.sha }}
    secrets: inherit

  complete-deployment-store:
    needs:
      - parse-tag
      - create-deployment
      - deploy-store
    if: always() && needs.parse-tag.outputs.package == 'store-observations' && needs.create-deployment.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Mark GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ needs.deploy-store.result }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ needs.create-deployment.outputs.deployment_id }}'),
              state,
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: `Deployment ${state}`
            });

  complete-deployment-fetch:
    needs:
      - parse-tag
      - create-deployment
      - deploy-fetch
    if: always() && needs.parse-tag.outputs.package == 'fetch-observations' && needs.create-deployment.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Mark GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ needs.deploy-fetch.result }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ needs.create-deployment.outputs.deployment_id }}'),
              state,
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: `Deployment ${state}`
            });

  complete-deployment-refine:
    needs:
      - parse-tag
      - create-deployment
      - deploy-refine
    if: always() && needs.parse-tag.outputs.package == 'refine-observations' && needs.create-deployment.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Mark GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ needs.deploy-refine.result }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ needs.create-deployment.outputs.deployment_id }}'),
              state,
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: `Deployment ${state}`
            });

  complete-deployment-backfill:
    needs:
      - parse-tag
      - create-deployment
      - deploy-backfill
    if: always() && needs.parse-tag.outputs.package == 'backfill-observations' && needs.create-deployment.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Mark GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ needs.deploy-backfill.result }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ needs.create-deployment.outputs.deployment_id }}'),
              state,
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: `Deployment ${state}`
            });

  complete-deployment-role-policy:
    needs:
      - parse-tag
      - create-deployment
      - deploy-role-policy
    if: always() && needs.parse-tag.outputs.package == 'github-tempest-cfn-deploy-role' && needs.create-deployment.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Mark GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ needs.deploy-role-policy.result }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ needs.create-deployment.outputs.deployment_id }}'),
              state,
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: `Deployment ${state}`
            });

  deployment-summary:
    needs:
      - parse-tag
      - create-deployment
      - deploy-store
      - deploy-fetch
      - deploy-refine
      - deploy-backfill
      - deploy-role-policy
      - deploy-cloud-computing
      - complete-deployment-store
      - complete-deployment-fetch
      - complete-deployment-refine
      - complete-deployment-backfill
      - complete-deployment-role-policy
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Write summary
        run: |
          {
            echo "## Deploy From Tag Summary"
            echo
            echo "- Tag: \`${{ github.ref_name }}\`"
            echo "- Package: \`${{ needs.parse-tag.outputs.package }}\`"
            echo "- Version: \`${{ needs.parse-tag.outputs.version }}\`"
            echo "- Environment: \`${{ needs.parse-tag.outputs.environment }}\`"
            echo "- CloudFormation package: \`${{ needs.parse-tag.outputs.supports_cloudformation }}\`"
            echo
            echo "| Job | Result |"
            echo "|---|---|"
            echo "| create-deployment | \`${{ needs.create-deployment.result }}\` |"
            echo "| deploy-store | \`${{ needs.deploy-store.result }}\` |"
            echo "| deploy-fetch | \`${{ needs.deploy-fetch.result }}\` |"
            echo "| deploy-refine | \`${{ needs.deploy-refine.result }}\` |"
            echo "| deploy-backfill | \`${{ needs.deploy-backfill.result }}\` |"
            echo "| deploy-role-policy | \`${{ needs.deploy-role-policy.result }}\` |"
            echo "| deploy-cloud-computing | \`${{ needs.deploy-cloud-computing.result }}\` |"
          } >> "$GITHUB_STEP_SUMMARY"
