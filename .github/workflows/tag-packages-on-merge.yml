name: Tag And Deploy Packages On Merge

on:
  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  contents: write
  id-token: write

jobs:
  prepare-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      merge_sha: ${{ steps.meta.outputs.merge_sha }}
      bump: ${{ steps.bump.outputs.bump }}
      cloud_changed: ${{ steps.changed.outputs.cloud }}
      store_changed: ${{ steps.changed.outputs.store }}
      fetch_changed: ${{ steps.changed.outputs.fetch }}
      refine_changed: ${{ steps.changed.outputs.refine }}
      backfill_changed: ${{ steps.changed.outputs.backfill }}
      role_changed: ${{ steps.changed.outputs.deploy_role }}
      cloud_tag: ${{ steps.tags.outputs.cloud_tag }}
      store_tag: ${{ steps.tags.outputs.store_tag }}
      fetch_tag: ${{ steps.tags.outputs.fetch_tag }}
      refine_tag: ${{ steps.tags.outputs.refine_tag }}
      backfill_tag: ${{ steps.tags.outputs.backfill_tag }}
      role_tag: ${{ steps.tags.outputs.role_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          persist-credentials: false

      - name: Capture merge metadata
        id: meta
        run: |
          echo "merge_sha=${{ github.event.pull_request.merge_commit_sha }}" >> "$GITHUB_OUTPUT"

      - name: Determine semver bump level
        id: bump
        run: |
          set -euo pipefail

          labels="$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" || true)"
          title="$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")"
          body="$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"

          if echo "$labels" | grep -Eq '^semver:major$'; then
            bump="major"
          elif echo "$labels" | grep -Eq '^semver:minor$'; then
            bump="minor"
          elif echo "$labels" | grep -Eq '^semver:patch$'; then
            bump="patch"
          elif printf '%s\n%s' "$title" "$body" | grep -Eq 'BREAKING CHANGE'; then
            bump="major"
          elif echo "$title" | grep -Eq '^[^:]+!:'; then
            bump="major"
          elif echo "$title" | grep -Eq '^feat(\(.+\))?:'; then
            bump="minor"
          else
            bump="patch"
          fi

          echo "bump=$bump" >> "$GITHUB_OUTPUT"

      - name: Determine changed packages
        id: changed
        uses: ./.github/actions/detect-package-changes
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.merge_commit_sha }}
          include_workflow_dependencies: "false"

      - name: Configure git committer identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Configure remote for tag push trigger token
        env:
          TAG_PUSH_TOKEN: ${{ secrets.TAG_PUSH_TOKEN }}
        run: |
          if [ -z "${TAG_PUSH_TOKEN:-}" ]; then
            echo "Repository secret TAG_PUSH_TOKEN must be set to a PAT or GitHub App token with repo contents:write."
            exit 1
          fi
          git remote set-url origin "https://x-access-token:${TAG_PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

      - name: Create and push package tags
        id: tags
        env:
          BUMP: ${{ steps.bump.outputs.bump }}
          CLOUD_CHANGED: ${{ steps.changed.outputs.cloud }}
          STORE_CHANGED: ${{ steps.changed.outputs.store }}
          FETCH_CHANGED: ${{ steps.changed.outputs.fetch }}
          REFINE_CHANGED: ${{ steps.changed.outputs.refine }}
          BACKFILL_CHANGED: ${{ steps.changed.outputs.backfill }}
          ROLE_CHANGED: ${{ steps.changed.outputs.deploy_role }}
        run: |
          set -euo pipefail

          bump_version() {
            local version="$1"
            local bump="$2"
            IFS='.' read -r major minor patch <<< "$version"
            case "$bump" in
              major)
                major=$((major + 1)); minor=0; patch=0
                ;;
              minor)
                minor=$((minor + 1)); patch=0
                ;;
              *)
                patch=$((patch + 1))
                ;;
            esac
            echo "${major}.${minor}.${patch}"
          }

          create_tag_for_package() {
            local package="$1"
            local changed="$2"
            local output_key="$3"

            if [ "$changed" != "true" ]; then
              echo "${output_key}=" >> "$GITHUB_OUTPUT"
              return 0
            fi

            local prefix="pkg/${package}/v"
            local latest
            latest="$(git tag -l "${prefix}*" | sed "s#${prefix}##" | sort -V | tail -n1)"
            if [ -z "$latest" ]; then
              latest="0.0.0"
            fi

            local next
            next="$(bump_version "$latest" "$BUMP")"
            local tag="${prefix}${next}"

            if git rev-parse "$tag" >/dev/null 2>&1; then
              echo "Tag already exists, skipping: $tag"
            else
              git tag -a "$tag" -m "Release ${package} ${next}"
              git push origin "$tag"
              echo "Published tag: $tag"
            fi

            echo "${output_key}=$tag" >> "$GITHUB_OUTPUT"
          }

          create_tag_for_package "cloud-computing" "$CLOUD_CHANGED" "cloud_tag"
          create_tag_for_package "store-observations" "$STORE_CHANGED" "store_tag"
          create_tag_for_package "fetch-observations" "$FETCH_CHANGED" "fetch_tag"
          create_tag_for_package "refine-observations" "$REFINE_CHANGED" "refine_tag"
          create_tag_for_package "backfill-observations" "$BACKFILL_CHANGED" "backfill_tag"
          create_tag_for_package "github-tempest-cfn-deploy-role" "$ROLE_CHANGED" "role_tag"

  test-cloud:
    needs: prepare-release
    if: needs.prepare-release.outputs.cloud_changed == 'true'
    uses: ./.github/workflows/reusable-run-package-tests.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package: cloud-computing
    secrets: inherit

  test-store:
    needs: prepare-release
    if: needs.prepare-release.outputs.store_changed == 'true'
    uses: ./.github/workflows/reusable-run-package-tests.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package: store-observations
    secrets: inherit

  test-fetch:
    needs: prepare-release
    if: needs.prepare-release.outputs.fetch_changed == 'true'
    uses: ./.github/workflows/reusable-run-package-tests.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package: fetch-observations
    secrets: inherit

  test-refine:
    needs: prepare-release
    if: needs.prepare-release.outputs.refine_changed == 'true'
    uses: ./.github/workflows/reusable-run-package-tests.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package: refine-observations
    secrets: inherit

  test-backfill:
    needs: prepare-release
    if: needs.prepare-release.outputs.backfill_changed == 'true'
    uses: ./.github/workflows/reusable-run-package-tests.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package: backfill-observations
    secrets: inherit

  deploy-cloud:
    needs:
      - prepare-release
      - test-cloud
    if: needs.prepare-release.outputs.cloud_changed == 'true' && needs.test-cloud.result == 'success'
    uses: ./.github/workflows/reusable-deploy-cloud-computing.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
    secrets: inherit

  deploy-store:
    needs:
      - prepare-release
      - test-store
    if: needs.prepare-release.outputs.store_changed == 'true' && needs.test-store.result == 'success'
    concurrency:
      group: deploy-prod-store-observations
      cancel-in-progress: false
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package_workspace: "@weather/store-observations"
      package_directory: packages/store-observations
      artifact_bucket: tempest-artifacts-store-prod-926898703023
      stack_name: tempest-weather-store-lib
    secrets: inherit

  deploy-fetch:
    needs:
      - prepare-release
      - test-fetch
    if: needs.prepare-release.outputs.fetch_changed == 'true' && needs.test-fetch.result == 'success'
    concurrency:
      group: deploy-prod-fetch-observations
      cancel-in-progress: false
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package_workspace: "@weather/fetch-observations"
      package_directory: packages/fetch-observations
      artifact_bucket: tempest-artifacts-fetch-prod-926898703023
      stack_name: tempest-weather-fetch-lib
    secrets: inherit

  deploy-refine:
    needs:
      - prepare-release
      - test-refine
    if: needs.prepare-release.outputs.refine_changed == 'true' && needs.test-refine.result == 'success'
    concurrency:
      group: deploy-prod-refine-observations
      cancel-in-progress: false
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      package_workspace: "@weather/refine-observations"
      package_directory: packages/refine-observations
      artifact_bucket: tempest-artifacts-refine-prod-926898703023
      stack_name: tempest-weather-refine-lib
    secrets: inherit

  deploy-backfill:
    needs:
      - prepare-release
      - test-backfill
    if: needs.prepare-release.outputs.backfill_changed == 'true' && needs.test-backfill.result == 'success'
    concurrency:
      group: deploy-prod-backfill-observations
      cancel-in-progress: false
    uses: ./.github/workflows/reusable-deploy-sam-backfill.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
      artifact_bucket: tempest-artifacts-backfill-prod-926898703023
      stack_name: tempest-weather-backfill-lib
    secrets: inherit

  deploy-role-policy:
    needs: prepare-release
    if: needs.prepare-release.outputs.role_changed == 'true'
    concurrency:
      group: deploy-prod-github-tempest-cfn-deploy-role
      cancel-in-progress: false
    uses: ./.github/workflows/reusable-deploy-role-policy.yml
    with:
      checkout_ref: ${{ needs.prepare-release.outputs.merge_sha }}
    secrets: inherit

  release-summary:
    needs:
      - prepare-release
      - test-cloud
      - test-store
      - test-fetch
      - test-refine
      - test-backfill
      - deploy-cloud
      - deploy-store
      - deploy-fetch
      - deploy-refine
      - deploy-backfill
      - deploy-role-policy
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Write consolidated summary
        run: |
          {
            echo "## Merge Release + Deploy Summary"
            echo
            echo "- Merge commit: \`${{ needs.prepare-release.outputs.merge_sha }}\`"
            echo "- Semver bump: \`${{ needs.prepare-release.outputs.bump }}\`"
            echo
            echo "### Tags"
            echo
            echo "| Package | Changed | Tag |"
            echo "|---|---|---|"
            echo "| cloud-computing | \`${{ needs.prepare-release.outputs.cloud_changed }}\` | \`${{ needs.prepare-release.outputs.cloud_tag }}\` |"
            echo "| store-observations | \`${{ needs.prepare-release.outputs.store_changed }}\` | \`${{ needs.prepare-release.outputs.store_tag }}\` |"
            echo "| fetch-observations | \`${{ needs.prepare-release.outputs.fetch_changed }}\` | \`${{ needs.prepare-release.outputs.fetch_tag }}\` |"
            echo "| refine-observations | \`${{ needs.prepare-release.outputs.refine_changed }}\` | \`${{ needs.prepare-release.outputs.refine_tag }}\` |"
            echo "| backfill-observations | \`${{ needs.prepare-release.outputs.backfill_changed }}\` | \`${{ needs.prepare-release.outputs.backfill_tag }}\` |"
            echo "| github-tempest-cfn-deploy-role | \`${{ needs.prepare-release.outputs.role_changed }}\` | \`${{ needs.prepare-release.outputs.role_tag }}\` |"
            echo
            echo "### Job Results"
            echo
            echo "| Job | Result |"
            echo "|---|---|"
            echo "| test-cloud | \`${{ needs.test-cloud.result }}\` |"
            echo "| test-store | \`${{ needs.test-store.result }}\` |"
            echo "| test-fetch | \`${{ needs.test-fetch.result }}\` |"
            echo "| test-refine | \`${{ needs.test-refine.result }}\` |"
            echo "| test-backfill | \`${{ needs.test-backfill.result }}\` |"
            echo "| deploy-cloud | \`${{ needs.deploy-cloud.result }}\` |"
            echo "| deploy-store | \`${{ needs.deploy-store.result }}\` |"
            echo "| deploy-fetch | \`${{ needs.deploy-fetch.result }}\` |"
            echo "| deploy-refine | \`${{ needs.deploy-refine.result }}\` |"
            echo "| deploy-backfill | \`${{ needs.deploy-backfill.result }}\` |"
            echo "| deploy-role-policy | \`${{ needs.deploy-role-policy.result }}\` |"
          } >> "$GITHUB_STEP_SUMMARY"
