name: Deploy Tempest Weather Fetch Lib

on:
  workflow_run:
    workflows:
      - Automation-Tests
    branches:
      - main
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::926898703023:role/GitHubTempestCfnDeployRole
          aws-region: eu-west-2

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Install dependencies
        run: npm ci

      - name: Ensure artifact bucket and lifecycle policy
        env:
          ARTIFACT_BUCKET: tempest-artifacts-fetch-prod-926898703023
          AWS_REGION: eu-west-2
        run: |
          if ! aws s3api head-bucket --bucket "$ARTIFACT_BUCKET" 2>/dev/null; then
            aws s3api create-bucket \
              --bucket "$ARTIFACT_BUCKET" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
          fi

          aws s3api put-bucket-lifecycle-configuration \
            --bucket "$ARTIFACT_BUCKET" \
            --lifecycle-configuration '{
              "Rules": [
                {
                  "ID": "ExpireSamArtifactsAfter30Days",
                  "Status": "Enabled",
                  "Filter": { "Prefix": "" },
                  "Expiration": { "Days": 30 },
                  "NoncurrentVersionExpiration": { "NoncurrentDays": 30 }
                }
              ]
            }'

      - name: Build fetch function and layer artifacts
        run: |
          npm run build --workspace=@weather/cloud-computing
          npm run build --workspace=@weather/fetch-observations
          mkdir -p lib/nodejs
          rm -rf lib/nodejs/node_modules
          cp -RL node_modules lib/nodejs

      - name: Build SAM application
        working-directory: packages/fetch-observations
        run: sam build --config-env prod

      - name: Load .env and set SAM deploy parameters
        id: dotenv
        run: |
          set -a
          source .env
          set +a
          echo "TEMPEST_HOST=$TEMPEST_HOST" >> $GITHUB_ENV
          echo "TEMPEST_TOKEN=$TEMPEST_TOKEN" >> $GITHUB_ENV
          echo "TEMPEST_DEVICE_ID=$TEMPEST_DEVICE_ID" >> $GITHUB_ENV
          echo "TEMPEST_STATION_ID=$TEMPEST_STATION_ID" >> $GITHUB_ENV

      - name: Deploy SAM application
        working-directory: packages/fetch-observations
        run: |
          sam deploy --config-env prod \
            --parameter-overrides \
              TempestHost=$TEMPEST_HOST \
              TempestToken=$TEMPEST_TOKEN \
              TempestDeviceId=$TEMPEST_DEVICE_ID \
              TempestStationId=$TEMPEST_STATION_ID
