name: Deploy Pipeline

on:
  workflow_run:
    workflows:
      - Automation-Tests
    branches:
      - main
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      deploy_role: ${{ steps.filter.outputs.deploy_role }}
      deploy_cloud: ${{ steps.filter.outputs.deploy_cloud }}
      deploy_store: ${{ steps.filter.outputs.deploy_store }}
      deploy_fetch: ${{ steps.filter.outputs.deploy_fetch }}
      deploy_refine: ${{ steps.filter.outputs.deploy_refine }}
      deploy_backfill: ${{ steps.filter.outputs.deploy_backfill }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 2

      - name: Determine package deployments required
        id: filter
        run: |
          deploy_role=false
          deploy_cloud=false
          deploy_store=false
          deploy_fetch=false
          deploy_refine=false
          deploy_backfill=false

          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "deploy_role=$deploy_role" >> "$GITHUB_OUTPUT"
            echo "deploy_cloud=$deploy_cloud" >> "$GITHUB_OUTPUT"
            echo "deploy_store=$deploy_store" >> "$GITHUB_OUTPUT"
            echo "deploy_fetch=$deploy_fetch" >> "$GITHUB_OUTPUT"
            echo "deploy_refine=$deploy_refine" >> "$GITHUB_OUTPUT"
            echo "deploy_backfill=$deploy_backfill" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            deploy_role=true
            deploy_cloud=true
            deploy_store=true
            deploy_fetch=true
            deploy_refine=true
            deploy_backfill=true
          else
            changed_files="$(git diff --name-only HEAD^ HEAD)"

            while IFS= read -r file; do
              case "$file" in
                infra/github-tempest-cfn-deploy-role/*|.github/workflows/reusable-deploy-role-policy.yml|.github/workflows/deploy-pipeline.yml)
                  deploy_role=true
                  ;;
              esac

              case "$file" in
                packages/cloud-computing/*|package.json|package-lock.json|.node-version|eslint.config.mjs|jest.config.cjs|tsconfig*)
                  deploy_cloud=true
                  ;;
              esac

              case "$file" in
                packages/store-observations/*|packages/cloud-computing/*|package.json|package-lock.json|.node-version|eslint.config.mjs|jest.config.cjs|tsconfig*|.github/workflows/reusable-deploy-sam-observations.yml)
                  deploy_store=true
                  ;;
              esac

              case "$file" in
                packages/fetch-observations/*|packages/cloud-computing/*|package.json|package-lock.json|.node-version|eslint.config.mjs|jest.config.cjs|tsconfig*|.github/workflows/reusable-deploy-sam-observations.yml)
                  deploy_fetch=true
                  ;;
              esac

              case "$file" in
                packages/refine-observations/*|packages/cloud-computing/*|package.json|package-lock.json|.node-version|eslint.config.mjs|jest.config.cjs|tsconfig*|.github/workflows/reusable-deploy-sam-observations.yml)
                  deploy_refine=true
                  ;;
              esac

              case "$file" in
                packages/backfill-observations/*|package.json|package-lock.json|.node-version|eslint.config.mjs|jest.config.cjs|tsconfig*|.github/workflows/reusable-deploy-sam-backfill.yml)
                  deploy_backfill=true
                  ;;
              esac
            done <<< "$changed_files"
          fi

          echo "deploy_role=$deploy_role" >> "$GITHUB_OUTPUT"
          echo "deploy_cloud=$deploy_cloud" >> "$GITHUB_OUTPUT"
          echo "deploy_store=$deploy_store" >> "$GITHUB_OUTPUT"
          echo "deploy_fetch=$deploy_fetch" >> "$GITHUB_OUTPUT"
          echo "deploy_refine=$deploy_refine" >> "$GITHUB_OUTPUT"
          echo "deploy_backfill=$deploy_backfill" >> "$GITHUB_OUTPUT"

  deploy-role-policy:
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_role == 'true'
    uses: ./.github/workflows/reusable-deploy-role-policy.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
    secrets: inherit

  deploy-cloud-computing:
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_cloud == 'true'
    uses: ./.github/workflows/reusable-deploy-cloud-computing.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
    secrets: inherit

  deploy-store:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_store == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      package_workspace: "@weather/store-observations"
      package_directory: packages/store-observations
      artifact_bucket: tempest-artifacts-store-prod-926898703023
    secrets: inherit

  deploy-fetch:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_fetch == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      package_workspace: "@weather/fetch-observations"
      package_directory: packages/fetch-observations
      artifact_bucket: tempest-artifacts-fetch-prod-926898703023
    secrets: inherit

  deploy-refine:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_refine == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      package_workspace: "@weather/refine-observations"
      package_directory: packages/refine-observations
      artifact_bucket: tempest-artifacts-refine-prod-926898703023
    secrets: inherit

  deploy-backfill:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_backfill == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-backfill.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      artifact_bucket: tempest-artifacts-backfill-prod-926898703023
    secrets: inherit

  deployment-summary:
    needs:
      - detect-changes
      - deploy-role-policy
      - deploy-cloud-computing
      - deploy-store
      - deploy-fetch
      - deploy-refine
      - deploy-backfill
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Write deployment summary
        run: |
          {
            echo "## Deployment Pipeline Summary"
            echo
            echo "- Source workflow: \`${{ github.event.workflow_run.name }}\`"
            echo "- Source conclusion: \`${{ github.event.workflow_run.conclusion }}\`"
            echo "- Commit: \`${{ github.event.workflow_run.head_sha }}\`"
            echo
            echo "| Component | Change Detected | Job Result |"
            echo "|---|---|---|"
            echo "| Role policy | \`${{ needs.detect-changes.outputs.deploy_role }}\` | \`${{ needs.deploy-role-policy.result }}\` |"
            echo "| Cloud computing package | \`${{ needs.detect-changes.outputs.deploy_cloud }}\` | \`${{ needs.deploy-cloud-computing.result }}\` |"
            echo "| Store observations | \`${{ needs.detect-changes.outputs.deploy_store }}\` | \`${{ needs.deploy-store.result }}\` |"
            echo "| Fetch observations | \`${{ needs.detect-changes.outputs.deploy_fetch }}\` | \`${{ needs.deploy-fetch.result }}\` |"
            echo "| Refine observations | \`${{ needs.detect-changes.outputs.deploy_refine }}\` | \`${{ needs.deploy-refine.result }}\` |"
            echo "| Backfill observations | \`${{ needs.detect-changes.outputs.deploy_backfill }}\` | \`${{ needs.deploy-backfill.result }}\` |"
          } >> "$GITHUB_STEP_SUMMARY"
