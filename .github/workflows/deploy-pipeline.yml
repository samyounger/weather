name: Deploy Pipeline

on:
  workflow_run:
    workflows:
      - Automation-Tests
    branches:
      - main
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      deploy_role: ${{ steps.changed.outputs.deploy_role }}
      deploy_cloud: ${{ steps.changed.outputs.cloud }}
      deploy_store: ${{ steps.changed.outputs.store }}
      deploy_fetch: ${{ steps.changed.outputs.fetch }}
      deploy_refine: ${{ steps.changed.outputs.refine }}
      deploy_backfill: ${{ steps.changed.outputs.backfill }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Resolve base commit
        id: base
        run: |
          if git rev-parse --verify "${{ github.event.workflow_run.head_sha }}^" >/dev/null 2>&1; then
            echo "sha=${{ github.event.workflow_run.head_sha }}^" >> "$GITHUB_OUTPUT"
          else
            echo "sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect package changes
        id: changed
        if: github.event.workflow_run.conclusion == 'success'
        uses: ./.github/actions/detect-package-changes
        with:
          base_sha: ${{ steps.base.outputs.sha }}
          head_sha: ${{ github.event.workflow_run.head_sha }}
          include_workflow_dependencies: "true"

  deploy-role-policy:
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_role == 'true'
    uses: ./.github/workflows/reusable-deploy-role-policy.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
    secrets: inherit

  deploy-cloud-computing:
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_cloud == 'true'
    uses: ./.github/workflows/reusable-deploy-cloud-computing.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
    secrets: inherit

  deploy-store:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_store == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      package_workspace: "@weather/store-observations"
      package_directory: packages/store-observations
      artifact_bucket: tempest-artifacts-store-prod-926898703023
    secrets: inherit

  deploy-fetch:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_fetch == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      package_workspace: "@weather/fetch-observations"
      package_directory: packages/fetch-observations
      artifact_bucket: tempest-artifacts-fetch-prod-926898703023
    secrets: inherit

  deploy-refine:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_refine == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-observations.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      package_workspace: "@weather/refine-observations"
      package_directory: packages/refine-observations
      artifact_bucket: tempest-artifacts-refine-prod-926898703023
    secrets: inherit

  deploy-backfill:
    needs:
      - detect-changes
      - deploy-role-policy
    if: needs.detect-changes.outputs.deploy_backfill == 'true' && (needs.deploy-role-policy.result == 'success' || needs.deploy-role-policy.result == 'skipped')
    uses: ./.github/workflows/reusable-deploy-sam-backfill.yml
    with:
      checkout_ref: ${{ github.event.workflow_run.head_sha }}
      artifact_bucket: tempest-artifacts-backfill-prod-926898703023
    secrets: inherit

  deployment-summary:
    needs:
      - detect-changes
      - deploy-role-policy
      - deploy-cloud-computing
      - deploy-store
      - deploy-fetch
      - deploy-refine
      - deploy-backfill
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Write deployment summary
        run: |
          {
            echo "## Deployment Pipeline Summary"
            echo
            echo "- Source workflow: \`${{ github.event.workflow_run.name }}\`"
            echo "- Source conclusion: \`${{ github.event.workflow_run.conclusion }}\`"
            echo "- Commit: \`${{ github.event.workflow_run.head_sha }}\`"
            echo
            echo "| Component | Change Detected | Job Result |"
            echo "|---|---|---|"
            echo "| Role policy | \`${{ needs.detect-changes.outputs.deploy_role }}\` | \`${{ needs.deploy-role-policy.result }}\` |"
            echo "| Cloud computing package | \`${{ needs.detect-changes.outputs.deploy_cloud }}\` | \`${{ needs.deploy-cloud-computing.result }}\` |"
            echo "| Store observations | \`${{ needs.detect-changes.outputs.deploy_store }}\` | \`${{ needs.deploy-store.result }}\` |"
            echo "| Fetch observations | \`${{ needs.detect-changes.outputs.deploy_fetch }}\` | \`${{ needs.deploy-fetch.result }}\` |"
            echo "| Refine observations | \`${{ needs.detect-changes.outputs.deploy_refine }}\` | \`${{ needs.deploy-refine.result }}\` |"
            echo "| Backfill observations | \`${{ needs.detect-changes.outputs.deploy_backfill }}\` | \`${{ needs.deploy-backfill.result }}\` |"
          } >> "$GITHUB_STEP_SUMMARY"
