AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: One-off backfill workflow to register historical S3 partitions in Athena.

Parameters:
  BackfillBucket:
    Type: String
    Default: weather-tempest-records
    Description: Bucket containing historical observation records and where manifests/chunks are written.
  BackfillScanPrefix:
    Type: String
    Default: ''
    Description: Optional S3 prefix to limit the scan scope.
  BackfillOutputPrefix:
    Type: String
    Default: backfill/athena-partitions
    Description: Prefix where run manifests and partition chunks are stored.
  RefinedBackfillOutputPrefix:
    Type: String
    Default: backfill/refined-15m
    Description: Prefix where refined backfill manifests and date chunks are stored.
  AthenaDatabase:
    Type: String
    Default: tempest_weather
  AthenaTable:
    Type: String
    Default: observations
  RefinedAthenaRawTable:
    Type: String
    Default: observations
  RefinedAthenaTable:
    Type: String
    Default: observations_refined_15m
  RefinedAthenaLocation:
    Type: String
    Default: s3://weather-tempest-records/refined/observations_refined_15m/
  AthenaOutputLocation:
    Type: String
    Default: s3://weather-tempest-records/queries/
  AthenaWorkGroup:
    Type: String
    Default: primary
  ChunkSize:
    Type: Number
    Default: 100
  RefinedChunkSize:
    Type: Number
    Default: 30
  AlertEmail:
    Type: String
    Default: ''
    Description: Optional email endpoint for CloudWatch alarm notifications.
Conditions:
  HasAlertEmail: !Not [!Equals [!Ref AlertEmail, '']]

Resources:
  AlertsTopic:
    Type: AWS::SNS::Topic
    Condition: HasAlertEmail
    Properties:
      TopicName: !Sub "${AWS::StackName}-alerts"
  AlertsTopicSubscription:
    Type: AWS::SNS::Subscription
    Condition: HasAlertEmail
    Properties:
      Protocol: email
      TopicArn: !Ref AlertsTopic
      Endpoint: !Ref AlertEmail
  AlertsTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Condition: HasAlertEmail
    Properties:
      Topics:
        - !Ref AlertsTopic
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudwatch.amazonaws.com
                - events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref AlertsTopic
  BackfillPlannerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs24.x
      Handler: planner.handler
      CodeUri: function/.
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          BACKFILL_BUCKET: !Ref BackfillBucket
          BACKFILL_SCAN_PREFIX: !Ref BackfillScanPrefix
          BACKFILL_OUTPUT_PREFIX: !Ref BackfillOutputPrefix
          BACKFILL_CHUNK_SIZE: !Ref ChunkSize
          BACKFILL_ATHENA_DATABASE: !Ref AthenaDatabase
          BACKFILL_ATHENA_TABLE: !Ref AthenaTable
          BACKFILL_ATHENA_OUTPUT: !Ref AthenaOutputLocation
          BACKFILL_ATHENA_WORKGROUP: !Ref AthenaWorkGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - s3:ListBucket
              Resource: !Sub arn:aws:s3:::${BackfillBucket}
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource: !Sub arn:aws:s3:::${BackfillBucket}/*
  BackfillWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs24.x
      Handler: worker.handler
      CodeUri: function/.
      Timeout: 900
      MemorySize: 1024
      Environment:
        Variables:
          BACKFILL_ATHENA_DATABASE: !Ref AthenaDatabase
          BACKFILL_ATHENA_TABLE: !Ref AthenaTable
          BACKFILL_ATHENA_OUTPUT: !Ref AthenaOutputLocation
          BACKFILL_ATHENA_WORKGROUP: !Ref AthenaWorkGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !Sub arn:aws:s3:::${BackfillBucket}/*
            - Effect: Allow
              Action:
                - s3:GetBucketLocation
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
              Resource: !Sub arn:aws:s3:::${BackfillBucket}
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
                - s3:GetObject
                - s3:AbortMultipartUpload
                - s3:ListMultipartUploadParts
              Resource: !Sub arn:aws:s3:::${BackfillBucket}/queries/*
            - Effect: Allow
              Action:
                - athena:StartQueryExecution
                - athena:GetQueryExecution
              Resource: '*'
            - Effect: Allow
              Action:
                - glue:GetDatabase
                - glue:GetDatabases
                - glue:GetTable
                - glue:GetTables
                - glue:GetPartition
                - glue:GetPartitions
                - glue:CreatePartition
                - glue:BatchCreatePartition
              Resource: '*'
  RefinedBackfillPlannerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs24.x
      Handler: refine-planner.handler
      CodeUri: function/.
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          BACKFILL_BUCKET: !Ref BackfillBucket
          BACKFILL_REFINED_OUTPUT_PREFIX: !Ref RefinedBackfillOutputPrefix
          BACKFILL_REFINED_CHUNK_SIZE: !Ref RefinedChunkSize
          BACKFILL_ATHENA_DATABASE: !Ref AthenaDatabase
          BACKFILL_REFINED_RAW_TABLE: !Ref RefinedAthenaRawTable
          BACKFILL_REFINED_TABLE: !Ref RefinedAthenaTable
          BACKFILL_REFINED_LOCATION: !Ref RefinedAthenaLocation
          BACKFILL_ATHENA_OUTPUT: !Ref AthenaOutputLocation
          BACKFILL_ATHENA_WORKGROUP: !Ref AthenaWorkGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource: !Sub arn:aws:s3:::${BackfillBucket}/*
  RefinedBackfillWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs24.x
      Handler: refine-worker.handler
      CodeUri: function/.
      Timeout: 900
      MemorySize: 1024
      Environment:
        Variables:
          BACKFILL_ATHENA_DATABASE: !Ref AthenaDatabase
          BACKFILL_REFINED_RAW_TABLE: !Ref RefinedAthenaRawTable
          BACKFILL_REFINED_TABLE: !Ref RefinedAthenaTable
          BACKFILL_REFINED_LOCATION: !Ref RefinedAthenaLocation
          BACKFILL_ATHENA_OUTPUT: !Ref AthenaOutputLocation
          BACKFILL_ATHENA_WORKGROUP: !Ref AthenaWorkGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !Sub arn:aws:s3:::${BackfillBucket}/*
            - Effect: Allow
              Action:
                - s3:GetBucketLocation
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
              Resource: !Sub arn:aws:s3:::${BackfillBucket}
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
                - s3:GetObject
                - s3:AbortMultipartUpload
                - s3:ListMultipartUploadParts
              Resource:
                - !Sub arn:aws:s3:::${BackfillBucket}/queries/*
                - !Sub arn:aws:s3:::${BackfillBucket}/refined/*
            - Effect: Allow
              Action:
                - athena:StartQueryExecution
                - athena:GetQueryExecution
                - athena:GetQueryResults
              Resource: '*'
            - Effect: Allow
              Action:
                - glue:GetDatabase
                - glue:GetDatabases
                - glue:GetTable
                - glue:GetTables
                - glue:GetPartition
                - glue:GetPartitions
                - glue:CreateTable
                - glue:UpdateTable
                - glue:CreatePartition
                - glue:BatchCreatePartition
              Resource: '*'
  BackfillSummarizeFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs24.x
      Handler: summarize.handler
      CodeUri: function/.
      Timeout: 60
      MemorySize: 256
      Policies:
        - AWSLambdaBasicExecutionRole
  BackfillStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: STANDARD
      Definition:
        Comment: Backfill historical S3 partition metadata into Athena.
        StartAt: EnsureMaxConcurrency
        States:
          EnsureMaxConcurrency:
            Type: Choice
            Choices:
              - Variable: $.maxConcurrency
                IsPresent: true
                Next: DetermineBackfillType
            Default: SetDefaultMaxConcurrency
          SetDefaultMaxConcurrency:
            Type: Pass
            Result: 3
            ResultPath: $.maxConcurrency
            Next: DetermineBackfillType
          DetermineBackfillType:
            Type: Choice
            Choices:
              - Variable: $.rawTable
                IsPresent: true
                Next: DelegateToRefinedBackfill
            Default: DetermineChunkSource
          DelegateToRefinedBackfill:
            Type: Task
            Resource: arn:aws:states:::states:startExecution.sync:2
            OutputPath: $.Output
            Parameters:
              StateMachineArn: !Ref RefinedBackfillStateMachine
              Input.$: $
            End: true
          DetermineChunkSource:
            Type: Choice
            Choices:
              - Variable: $.chunkKeys[0]
                IsPresent: true
                Next: ProcessChunks
            Default: RunPlanner
          RunPlanner:
            Type: Task
            Resource: arn:aws:states:::lambda:invoke
            OutputPath: $.Payload
            Parameters:
              FunctionName: !GetAtt BackfillPlannerFunction.Arn
              Payload:
                bucket.$: $.bucket
                prefix.$: $.prefix
                outputPrefix.$: $.outputPrefix
                chunkSize.$: $.chunkSize
                maxConcurrency.$: $.maxConcurrency
            Next: EnsureMaxConcurrency
          ProcessChunks:
            Type: Map
            ItemsPath: $.chunkKeys
            ResultPath: $.chunkResults
            MaxConcurrencyPath: $.maxConcurrency
            ItemSelector:
              chunkKey.$: $$.Map.Item.Value
              bucket.$: $.bucket
              database.$: $.database
              table.$: $.table
              outputLocation.$: $.outputLocation
              workGroup.$: $.workGroup
            ItemProcessor:
              StartAt: RunWorker
              States:
                RunWorker:
                  Type: Task
                  Resource: arn:aws:states:::lambda:invoke
                  OutputPath: $.Payload
                  Parameters:
                    FunctionName: !GetAtt BackfillWorkerFunction.Arn
                    Payload:
                      bucket.$: $.bucket
                      chunkKey.$: $.chunkKey
                      database.$: $.database
                      table.$: $.table
                      outputLocation.$: $.outputLocation
                      workGroup.$: $.workGroup
                  Next: ChunkSucceeded
                  Catch:
                    - ErrorEquals:
                        - States.ALL
                      ResultPath: $.error
                      Next: ChunkFailed
                ChunkSucceeded:
                  Type: Pass
                  Parameters:
                    success: true
                    chunkKey.$: $.chunkKey
                    result.$: $
                  End: true
                ChunkFailed:
                  Type: Pass
                  Parameters:
                    success: false
                    chunkKey.$: $.chunkKey
                    error.$: $.error
                  End: true
            Next: SummarizeResults
          SummarizeResults:
            Type: Task
            Resource: arn:aws:states:::lambda:invoke
            OutputPath: $.Payload
            Parameters:
              FunctionName: !GetAtt BackfillSummarizeFunction.Arn
              Payload:
                chunkResults.$: $.chunkResults
            Next: CheckSummaryFailures
          CheckSummaryFailures:
            Type: Choice
            Choices:
              - Variable: $.failedChunks
                NumericGreaterThan: 0
                Next: BackfillFailed
            Default: Done
          BackfillFailed:
            Type: Fail
            Error: BackfillChunkFailures
            Cause: Backfill execution completed with failed chunks.
          Done:
            Type: Succeed
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !Ref RefinedBackfillStateMachine
            - Effect: Allow
              Action:
                - states:DescribeExecution
                - states:StopExecution
              Resource: !Sub arn:aws:states:${AWS::Region}:${AWS::AccountId}:execution:*
        - LambdaInvokePolicy:
            FunctionName: !Ref BackfillPlannerFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref BackfillWorkerFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref BackfillSummarizeFunction
  RefinedBackfillStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: STANDARD
      Definition:
        Comment: Backfill historical refined 15-minute records into Athena.
        StartAt: EnsureMaxConcurrency
        States:
          EnsureMaxConcurrency:
            Type: Choice
            Choices:
              - Variable: $.maxConcurrency
                IsPresent: true
                Next: DetermineChunkSource
            Default: SetDefaultMaxConcurrency
          SetDefaultMaxConcurrency:
            Type: Pass
            Result: 3
            ResultPath: $.maxConcurrency
            Next: DetermineChunkSource
          DetermineChunkSource:
            Type: Choice
            Choices:
              - Variable: $.chunkKeys[0]
                IsPresent: true
                Next: ProcessChunks
            Default: RunPlanner
          RunPlanner:
            Type: Task
            Resource: arn:aws:states:::lambda:invoke
            OutputPath: $.Payload
            Parameters:
              FunctionName: !GetAtt RefinedBackfillPlannerFunction.Arn
              Payload:
                bucket.$: $.bucket
                outputPrefix.$: $.outputPrefix
                chunkSize.$: $.chunkSize
                maxConcurrency.$: $.maxConcurrency
                startDate.$: $.startDate
                endDate.$: $.endDate
                database.$: $.database
                rawTable.$: $.rawTable
                refinedTable.$: $.refinedTable
                refinedLocation.$: $.refinedLocation
                outputLocation.$: $.outputLocation
                workGroup.$: $.workGroup
            Next: EnsureMaxConcurrency
          ProcessChunks:
            Type: Map
            ItemsPath: $.chunkKeys
            ResultPath: $.chunkResults
            MaxConcurrencyPath: $.maxConcurrency
            ItemSelector:
              chunkKey.$: $$.Map.Item.Value
              bucket.$: $.bucket
              database.$: $.database
              rawTable.$: $.rawTable
              refinedTable.$: $.refinedTable
              refinedLocation.$: $.refinedLocation
              outputLocation.$: $.outputLocation
              workGroup.$: $.workGroup
            ItemProcessor:
              StartAt: RunWorker
              States:
                RunWorker:
                  Type: Task
                  Resource: arn:aws:states:::lambda:invoke
                  OutputPath: $.Payload
                  Parameters:
                    FunctionName: !GetAtt RefinedBackfillWorkerFunction.Arn
                    Payload:
                      bucket.$: $.bucket
                      chunkKey.$: $.chunkKey
                      database.$: $.database
                      rawTable.$: $.rawTable
                      refinedTable.$: $.refinedTable
                      refinedLocation.$: $.refinedLocation
                      outputLocation.$: $.outputLocation
                      workGroup.$: $.workGroup
                  Next: ChunkSucceeded
                  Catch:
                    - ErrorEquals:
                        - States.ALL
                      ResultPath: $.error
                      Next: ChunkFailed
                ChunkSucceeded:
                  Type: Pass
                  Parameters:
                    success: true
                    chunkKey.$: $.chunkKey
                    result.$: $
                  End: true
                ChunkFailed:
                  Type: Pass
                  Parameters:
                    success: false
                    chunkKey.$: $.chunkKey
                    error.$: $.error
                  End: true
            Next: SummarizeResults
          SummarizeResults:
            Type: Task
            Resource: arn:aws:states:::lambda:invoke
            OutputPath: $.Payload
            Parameters:
              FunctionName: !GetAtt BackfillSummarizeFunction.Arn
              Payload:
                chunkResults.$: $.chunkResults
            Next: CheckSummaryFailures
          CheckSummaryFailures:
            Type: Choice
            Choices:
              - Variable: $.failedChunks
                NumericGreaterThan: 0
                Next: BackfillFailed
            Default: Done
          BackfillFailed:
            Type: Fail
            Error: BackfillChunkFailures
            Cause: Refined backfill execution completed with failed chunks.
          Done:
            Type: Succeed
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref RefinedBackfillPlannerFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref RefinedBackfillWorkerFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref BackfillSummarizeFunction
  BackfillExecutionStatusEventRule:
    Type: AWS::Events::Rule
    Condition: HasAlertEmail
    Properties:
      Description: Notify when backfill execution fails, times out, or is aborted.
      EventPattern:
        source:
          - aws.states
        detail-type:
          - Step Functions Execution Status Change
        detail:
          status:
            - FAILED
            - TIMED_OUT
            - ABORTED
          stateMachineArn:
            - !Ref BackfillStateMachine
            - !Ref RefinedBackfillStateMachine
      Targets:
        - Arn: !Ref AlertsTopic
          Id: BackfillExecutionStatusAlertTarget
  BackfillPlannerErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmDescription: !Sub "Lambda ${BackfillPlannerFunction} reported errors."
      Namespace: AWS/Lambda
      MetricName: Errors
      Dimensions:
        - Name: FunctionName
          Value: !Ref BackfillPlannerFunction
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlertsTopic
  BackfillWorkerErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmDescription: !Sub "Lambda ${BackfillWorkerFunction} reported errors."
      Namespace: AWS/Lambda
      MetricName: Errors
      Dimensions:
        - Name: FunctionName
          Value: !Ref BackfillWorkerFunction
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlertsTopic
  BackfillSummarizeErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmDescription: !Sub "Lambda ${BackfillSummarizeFunction} reported errors."
      Namespace: AWS/Lambda
      MetricName: Errors
      Dimensions:
        - Name: FunctionName
          Value: !Ref BackfillSummarizeFunction
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlertsTopic
  BackfillWorkerThrottlesAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmDescription: !Sub "Lambda ${BackfillWorkerFunction} reported throttles."
      Namespace: AWS/Lambda
      MetricName: Throttles
      Dimensions:
        - Name: FunctionName
          Value: !Ref BackfillWorkerFunction
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlertsTopic
  BackfillExecutionsFailedAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmDescription: Backfill Step Functions execution failed.
      Namespace: AWS/States
      MetricName: ExecutionsFailed
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref BackfillStateMachine
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlertsTopic
  BackfillExecutionsTimedOutAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmDescription: Backfill Step Functions execution timed out.
      Namespace: AWS/States
      MetricName: ExecutionsTimedOut
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref BackfillStateMachine
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlertsTopic
  BackfillExecutionsAbortedAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmDescription: Backfill Step Functions execution aborted.
      Namespace: AWS/States
      MetricName: ExecutionsAborted
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref BackfillStateMachine
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref AlertsTopic

Outputs:
  AlertsTopicArn:
    Condition: HasAlertEmail
    Value: !Ref AlertsTopic
  BackfillStateMachineArn:
    Value: !Ref BackfillStateMachine
  BackfillPlannerFunctionArn:
    Value: !GetAtt BackfillPlannerFunction.Arn
  BackfillWorkerFunctionArn:
    Value: !GetAtt BackfillWorkerFunction.Arn
  BackfillSummarizeFunctionArn:
    Value: !GetAtt BackfillSummarizeFunction.Arn
  RefinedBackfillStateMachineArn:
    Value: !Ref RefinedBackfillStateMachine
  RefinedBackfillPlannerFunctionArn:
    Value: !GetAtt RefinedBackfillPlannerFunction.Arn
  RefinedBackfillWorkerFunctionArn:
    Value: !GetAtt RefinedBackfillWorkerFunction.Arn
